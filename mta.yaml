_schema-version: "3.1"
ID: work_hub
version: 1.0.0
description: "WorkHub - Multi-tenant SaaS Project & Task Management"

parameters:
  enable-parallel-deployments: true

build-parameters:
  before-all:
    - builder: custom
      commands:
        - npx -p @sap/cds-dk cds build --production

modules:
  # ------------------------------------------------------------
  # 1) CAP Service (MTX Provider)
  # ------------------------------------------------------------
  - name: work_hub-srv
    type: nodejs
    path: gen/srv
    parameters:
      memory: 512M
    requires:
      - name: work_hub-db
      - name: work_hub-auth
      - name: work_hub-sm
      - name: work_hub-registry
      - name: app-api
        properties:
          SUBSCRIPTION_URL: ~{app-protocol}://\${tenant_subdomain}-~{app-uri}
      - name: work_hub-auth
        group: destinations
        properties:
          xsappname: work_hub-${org}-${space}

    provides:
      - name: srv-api
        properties:
          srv-url: ${default-url}

  # ------------------------------------------------------------
  # 2) Approuter (Entry Point)
  # ------------------------------------------------------------
  - name: work_hub-router
    type: approuter.nodejs
    path: app/router
    parameters:
      memory: 256M
      keep-existing-routes: true

    properties:
      TENANT_HOST_PATTERN: '^(.*)-${default-uri}'
      SAP_JWT_TRUST_ACL:
        - clientid: "*"
          identityzone: sap-provisioning

    requires:
      - name: work_hub-auth
      - name: srv-api
        group: destinations
        properties:
          name: work_hub-srv
          url: ~{srv-url}
          forwardAuthToken: true

    build-parameters:
      requires:
        - name: work_hub-react-builder
          artifacts:
            - '*'
          target-path: resources/

    provides:
      - name: app-api
        properties:
          app-protocol: ${protocol}
          app-uri: ${default-uri}

  # ------------------------------------------------------------
  # 3) DB Deployer
  # ------------------------------------------------------------
  - name: work_hub-db-deployer
    type: hdb
    path: gen/db
    parameters:
      memory: 256M
    requires:
      - name: work_hub-db

  # ------------------------------------------------------------
  # 4) React Builder
  # ------------------------------------------------------------
  - name: work_hub-react-builder
    type: custom
    path: app/work_hub_app
    build-parameters:
      builder: custom
      commands:
        - npm ci --legacy-peer-deps
        - npm run build
      supported-platforms: []
      build-result: build

resources:
  # ------------------------------------------------------------
  # HANA HDI
  # ------------------------------------------------------------
  - name: work_hub-db
    type: com.sap.xs.hdi-container
    parameters:
      service: hana
      service-plan: hdi-shared

  # ------------------------------------------------------------
  # XSUAA (tenant-mode shared)
  # ------------------------------------------------------------
  - name: work_hub-auth
    type: org.cloudfoundry.managed-service
    parameters:
      service: xsuaa
      service-plan: application
      path: ./xs-security.json
      config:
        xsappname: work_hub-${org}-${space}
        tenant-mode: shared

  # ------------------------------------------------------------
  # SaaS Registry (Provisioning Service)
  # ------------------------------------------------------------
  - name: work_hub-registry
    type: org.cloudfoundry.managed-service
    requires:
      - name: srv-api
      - name: app-api
    parameters:
      service: saas-registry
      service-plan: application
      config:
        xsappname: work_hub-${org}-${space}
        appName: work_hub
        displayName: "WorkHub"
        description: "Multi-tenant Project & Task Management"
        category: "SaaS"
        appUrls:
          onSubscription: ~{srv-api/srv-url}/-/cds/saas-provisioning/tenant/{tenantId}
          getDependencies: ~{srv-api/srv-url}/-/cds/saas-provisioning/dependencies
          url: ~{app-api/app-protocol}://~{app-api/app-uri}/

  # ------------------------------------------------------------
  # Service Manager (optional)
  # ------------------------------------------------------------
  - name: work_hub-sm
    type: org.cloudfoundry.managed-service
    parameters:
      service: service-manager
      service-plan: container

